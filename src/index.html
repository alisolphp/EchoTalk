<!DOCTYPE html>
<html lang="en" class="h-100" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>EchoTalk | Offline Shadowing Practice</title>
    <meta name="theme-color" content="#43b6fd">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-512.png">
</head>
<body class="d-flex flex-column h-100">
<div class="container my-4">
    <div class="d-flex justify-content-center align-items-center gap-2">
        <h1 class="mb-0"><img src="icons/icon-512.png" style="width: 1em;"> EchoTalk</h1>
        <select id="headerLanguageSelect" class="form-select form-select-sm header-lang-select" aria-label="Select Language"></select>
    </div>
    <h2 class="mb-3 text-center">Offline Shadowing Practice</h2>

    <div class="row mb-2">
        <div class="col text-center">
            <div id="backHomeButton" class="d-none">
                <button class="btn btn-outline-secondary">¬´ Back Home</button>
            </div>
            <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#quickStartModal"><i class="bi bi-info-circle-fill"></i> Quick Start</button>
        </div>
    </div>

    <div id="configArea">
        <div class="row mb-3">
            <div class="col text-center d-flex justify-content-center gap-2">
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#optionsModal"><i class="bi bi-sliders"></i> Options</button>
                <button id="showRecordingsBtn" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#recordingsModal"><i class="bi bi-file-earmark-music"></i> My Records</button>
            </div>
        </div>
        <div class="mb-3">
            <label for="sentenceInput" class="form-label">Enter your sentence or
                <button id="useSampleBtn" class="btn btn-secondary small py-0 px-2 me-1">Use a random Sample</button>:
            </label>
            <textarea id="sentenceInput" class="form-control" placeholder="Type or pick a sample sentence"></textarea>
        </div>
        <div class="mb-3">
            <div id="sampleSentence" class="fs-5"></div>
            <small class="text-muted">Click any word to set the starting point.</small>
        </div>

        <div class="row mb-3">
            <div class="col">
                <button id="startBtn" class="btn btn-primary d-block w-100"><i class="bi bi-rocket-takeoff-fill"></i> Start Practice</button>
            </div>
        </div>
    </div>

    <div id="practiceArea" class="d-none">
        <div id="practice-ui-container">
            <div class="mb-3">
                <div id="fullSentence" class="fs-5 mb-2 d-none"></div>

                <button id="slowBtn" style="margin-top: -0.3em;font-size: 20pt; color:#8fc9ff; text-shadow: 0px 0px 10px #59acf9;"
                        class="btn pt-1 pb-2 px-2" title="Play Slower">
                    <i class="bi bi-play-fill"></i><sub style="margin-left: -10px; font-size: 0.5em;">üê¢</sub>
                </button>

                <button id="fastBtn" style="margin-top: -0.3em;font-size: 20pt; color:#8fc9ff; text-shadow: 0px 0px 10px #59acf9; margin-left: -5px;"
                        class="btn pt-1 pb-2 px-2" title="Play Faster">
                    <i class="bi bi-play-fill"></i><sub style="margin-left: -10px; font-size: 0.5em;">üêá</sub>
                </button>

                <div id="sentence-container" class="fs-3 fw-bold mb-3 d-inline"></div>
            </div>
            <p id="instructionText">Now it‚Äôs your turn. Tap the mic icon on your keyboard and speak the word.</p>
            <div class="input-group mb-3">
                <input type="text" id="userInput" class="form-control" placeholder="Tap keyboard mic">
            </div>
            <div>
                <button id="checkBtn" class="btn btn-success d-block w-100 py-3">Check/Skip</button>
            </div>
            <div class="visualizer-container">
                <img src="images/sound-wave-animation.webp" id="soundWaveVisualizer" alt="Sound Wave Animation">
            </div>
            <div id="feedback" class="mb-3" style="min-height: 60px;">
                <canvas id="audio-visualizer" class="d-none" height="50"></canvas>
                <div id="feedback-text" class="fs-5"></div>
            </div>
        </div>
        <div id="session-complete-container" class="d-none"></div>
    </div>

    <div id="optionsModal" class="modal fade" tabindex="-1" aria-labelledby="optionsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="optionsModalLabel">Practice Options <small class="text-muted">(Auto save)</small></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <div class="card bg-dark-subtle mb-3">
                        <div class="card-body">
                            <h6 class="card-title mb-3">Select Content to Practice</h6>
                            <div class="row mb-3">
                                <div class="col">
                                    <label for="languageSelect" class="form-label fw-bold"><i class="bi bi-translate" style="color: #677fff;"></i> Select Language:</label>
                                    <select id="languageSelect" class="form-select"></select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <label for="levelSelect" class="form-label fw-bold"><i class="bi bi-bar-chart-line-fill" style="color: #39bc58;"></i> Level:</label>
                                    <select id="levelSelect" class="form-select"></select>
                                </div>
                                <div class="col">
                                    <label for="categorySelect" class="form-label fw-bold"><i class="bi bi-folder-fill" style="color: #ffcb00;"></i> Category:</label>
                                    <select id="categorySelect" class="form-select"></select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark-subtle mb-3">
                        <div class="card-body">
                            <h6 class="card-title mb-3">Practice Configuration</h6>

                            <div class="mb-3">
                                <label for="practiceModeSelect" class="form-label fw-bold">Practice Mode:</label>
                                <select id="practiceModeSelect" class="form-select">
                                    <option value="skip">üéß Skip-Only (Listen &amp; Repeat)</option>
                                    <option value="auto-skip">üïí Auto-Skip (Practice Within Time)</option>
                                    <option value="check">üé§ Check Mode (Use Keyboard's Mic)</option>
                                </select>
                            </div>

                            <div class="row mb-3">
                                <div class="col">
                                    <label for="speechRateSelect" class="form-label fw-bold">Speech Speed:</label>
                                    <select id="speechRateSelect" class="form-select">
                                        <option value="0.6">üê¢ Slow</option>
                                        <option value="0.8">üßç Medium</option>
                                        <option value="1">üö∂ Normal</option>
                                        <option value="1.2">üèÉ Fast</option>
                                        <option value="1.4">üöó Furious</option>
                                    </select>
                                </div>

                                <div class="col">
                                    <label for="repsSelect" class="form-label fw-bold">Repetitions:</label>
                                    <select id="repsSelect" class="form-select"></select>
                                </div>
                            </div>

                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="recordToggle">
                                <label class="form-check-label" for="recordToggle"><i class="bi bi-mic-fill" style="color: #ffb300;"></i> <strong>Record my voice</strong> to compare later (completely locally)</label>
                            </div>
                        </div>
                    </div>

                    <div class="card border-danger p-0">
                        <details>
                            <summary class="card-title text-danger small p-2 m-0">Danger Zone</summary>
                            <div class="card-body">
                                <p class="card-text small text-muted">This will permanently delete all your data and recordings.</p>
                                <button id="resetBtn" class="btn btn-danger w-100">Reset App</button>
                            </div>
                        </details>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-success opacity-50" data-bs-dismiss="modal">
                            <i class="bi bi-check-square-fill"></i>
                            <small>Saved Automatically</small>
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="quickStartModal" tabindex="-1" aria-labelledby="quickStartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quickStartModalLabel">Quick Start Guide & Features</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>This tool is designed for Shadowing practice and works completely offline. To get started, you can either enter your own sentence or use one of the provided samples.</p>
                    <h5>Quick Start Guide:</h5>
                    <ol>
                        <li><strong>Enter your sentence:</strong> Type the text you want to practice into the text box.</li>
                        <li><strong>Or use a sample:</strong> Click the <strong>"Use a random Sample"</strong> button to load a random sentence.</li>
                        <li><strong>Select a Practice Mode:</strong>
                            <ul>
                                <li><strong>Check Mode:</strong> After listening, repeat the phrase using your keyboard's mic and press "Check" to evaluate your pronunciation.</li>
                                <li><strong>Skip-Only Mode:</strong> Simply listen, repeat to yourself, and then press "Next Step" to proceed. (This is the default mode).</li>
                            </ul>
                        </li>
                        <li>Press the <strong>"Start Practice"</strong> button to begin.</li>
                    </ol>
                    <hr>
                    <h5>Other Features:</h5>
                    <ul>
                        <li><strong>Start From Any Word:</strong> Before starting, click any word in the full sentence to set it as your starting point.</li>
                        <li><strong>Re-listen at Slow Speed:</strong> During practice, click the <i class="bi bi-play-fill"></i> button at the beginning of the phrase to hear it again at a slower speed.</li>
                        <li><strong>Look Up Word Meanings:</strong> Click on any word in the phrase being displayed to search for its meaning on Google in a new tab.</li>
                        <li><strong>Record Your Voice:</strong> You can enable voice recording to save your attempts locally in your browser and compare them with the original audio later.</li>
                        <li><strong>Auto-Save Progress:</strong> Your settings and current progress are automatically saved, allowing you to easily continue your practice later.</li>
                        <li><strong>Analyze with AI:</strong> In the 'My Records' modal, click the <i class="bi bi-magic"></i> <strong>Analyze with AI</strong> button next to your recording. This instantly copies a detailed prompt to your clipboard and downloads your audio file. You can then upload the file to an AI chatbot (like Gemini) and paste the prompt to get a free, fast, and accurate analysis of your pronunciation.</li>
                    </ul>

                    <hr>
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <i class="bi bi-lightbulb-fill flex-shrink-0 me-2"></i>
                        <div>
                            <strong>Pro-Tip:</strong> For the fastest performance, turn off your internet connection. This ensures the app uses your device's local speech engines, which are much faster than online services.
                        </div>
                    </div>

                    <hr>
                    <p class="small text-muted">This tool works completely offline. No internet connection is required, and your privacy is protected as no data is sent to any server. Please ensure you have the
                        <span class="current-language-general-name">English</span>
                        TTS (Text-to-Speech) engine installed on your device.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="wordActionsModal" tabindex="-1" aria-labelledby="wordActionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="wordActionsModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="d-grid gap-2">
                        <button id="playWordBtn" class="btn btn-primary"><i class="bi bi-play-fill"></i> Play Word Again</button>
                        <a id="searchPronunciationLink" href="#" target="_blank" class="btn btn-outline-info">How to Pronounce <i class="bi bi-box-arrow-up-right"></i></a>
                        <a id="searchExamplesLink" href="#" target="_blank" class="btn btn-outline-warning">Usage Examples <i class="bi bi-box-arrow-up-right"></i></a>
                        <a id="searchMeaningLink" href="#" target="_blank" class="btn btn-outline-light">Word Meaning <i class="bi bi-box-arrow-up-right"></i></a>
                        <a id="searchSentenceMeaningLink" class="btn btn-outline-light">Sentence Meaning <i class="bi bi-box-arrow-up-right"></i></a>
                        <a id="translateWithGptBtn" href="#" class="btn btn-outline-primary">Copy AI Translation Prompt <i class="bi bi-robot"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="recordingsModal" tabindex="-1" aria-labelledby="recordingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recordingsModalLabel">My Recordings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="accordion" id="recordingsList"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="ttsWarningModal" tabindex="-1" aria-labelledby="ttsWarningModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ttsWarningModalLabel"><i class="bi bi-exclamation-triangle-fill text-warning"></i> TTS Engine Warning</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>It appears the Text-to-Speech (TTS) engine for <strong class="current-language-general-name">English</strong> language is not installed on your device.</p>
                    <p>The app will still function, but it may require an internet connection to play audio, which could result in slower performance and delays.</p>
                    <hr>
                    <div class="mt-3">
                        <p class="fw-bold">Recommended Solution:</p>
                        <p>For the best offline experience, please install the required voice engine from your device's settings:</p>

                        <details class="card bg-dark-subtle border-secondary mb-2">
                            <summary class="card-title fw-bold p-2" style="cursor: pointer; list-style: none;">
                                ‚Ä∫ On Mobile
                            </summary>
                            <div class="card-body pt-0">
                                <p>Check your device's <code>Accessibility</code> or <code>Text-to-speech</code> settings.</p>
                                <p class="small text-muted mt-2"><strong>Note:</strong> You may need to restart your browser after installation.</p>
                            </div>
                        </details>

                        <details class="card bg-dark-subtle border-secondary mb-2">
                            <summary class="card-title fw-bold p-2" style="cursor: pointer; list-style: none;">
                                ‚Ä∫ On Windows
                            </summary>
                            <div class="card-body pt-0">
                                <p>Go to <code>Settings > Time & Language > Speech</code> and click "Add voices".</p>
                                <p class="small text-muted mt-2"><strong>Note:</strong> You may need to restart your browser after installation.</p>
                            </div>
                        </details>

                        <details class="card bg-dark-subtle border-secondary">
                            <summary class="card-title fw-bold p-2" style="cursor: pointer; list-style: none;">
                                ‚Ä∫ On macOS
                            </summary>
                            <div class="card-body pt-0">
                                <p>Go to <code>System Settings > Accessibility > Spoken Content</code> and select "Manage Voices...".</p>
                                <p class="small text-muted mt-2"><strong>Note:</strong> You may need to restart your browser after installation.</p>
                            </div>
                        </details>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="aiInstructionsModal" tabindex="-1" aria-labelledby="aiInstructionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiInstructionsModalLabel"><i class="bi bi-robot text-info"></i> AI Analysis Guide</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="aiInstructionsModalBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Got it</button>
                    <a href="https://gemini.google.com/" target="_blank" class="btn btn-primary">Go to Gemini <i class="bi bi-box-arrow-up-right"></i></a>
                </div>
            </div>
        </div>
    </div>

</div>

<footer class="text-center text-muted small mt-auto py-2 opacity-25">
    <div id="app-version"></div>
</footer>

<button id="installBtn" class="btn btn-outline-primary d-none">Install App</button>

<script type="module" src="assets/js/app.ts"></script>
</body>
</html>